<!DOCTYPE html>
<html lang="en"><head>
        <title>Beam: a DOM-aware webserver</title>
        <script type="module" src="https://jamesaduncan.github.io/form-template/index.mjs"></script>
        <script type="module" src="https://jamesaduncan.github.io/button-remove/index.mjs"></script>
        <script type="module" src="https://jamesaduncan.github.io/dom-inline-example/index.mjs"></script>
        <script type="module" src="./index.mjs"></script>
        <style>
            body {
                font-family: sans-serif;
            }

            .description, .demo {
                width: 50%;
            }
        </style>
    </head>
    <body>
        <section class="description">
            <h1>Beam: a DOM-aware webserver</h1>
            <p>
                A DOM-aware webserver is a webserver that can interact with the DOM on the server-side, in a way
                that is very similar to a client. For example, a DOM-aware webserver should be able to serve
                page snipets by having a range specified by a selector in the HTTP headers.
            </p>
            <p>
                Similarly, it should be possible to change parts of the DOM by using HTTP verbs other than GET. The 
                DELETE method should be able to remove specified DOM elements, the PUT method should be able to insert
                a DOM element, and a PATCH should be able to do some amalgam of the two.
            </p>
            <p>

            </p>
        </section>
        <section class="demo">
            <h1>Demonstration</h1>
            <p>
                Using Beam, these demonstrations would alter the DOM on both the client and on the server.
            </p>
            <h2>PUT requests</h2>
            <p>
                The first example creates a ClickCounter custom element with a put method in the custom element's
                class. When the button is clicked, it calls the HTTP method specified in the <code>method</code>
                attribute on the element specified by the selector in the <code>action</code> attribute. In this
                example's case, it is just the click-counter button as it's the only one on the page.
            </p>
            <section id="simple-button">
                <script type="module">
                    class ClickCounter extends HTMLElement{
                        constructor() {
                            super();
                        }

                        put() {
                            let value = parseInt( this.innerHTML );
                            this.innerHTML = value + 1;
                        }
                    }
                    customElements.define('click-counter', ClickCounter);
                </script>
                <p>
                    The button has been clicked <click-counter>126</click-counter> times.
                </p>
                <button action="click-counter" method="put">Increase Counter</button>
            </section>
            <p>
                This also triggers a PUT request to the web server that served this page, such that the dom element
                specified by the selector in the <code>action</code> attribute is replaced by the same DOM element
                from the client. In the request below, you'll notice that the Range header is included, with a
                range specifier that looks like <code>selector=click-counter</code>. This matches the selector specified
                in the <code>action</code> attribute of the <code>button</code> element, and tells the DOM-aware server
                the part of the document we're interested in.
            </p>
            <p>
                You'll notice that the body of the request matches a snippet of HTML that represents what the client thinks
                should be in that position in the document.
            </p>
            <pre>        
                PUT / HTTP/1.1
                Accept: */*
                Accept-Encoding: identity
                Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
                Connection: keep-alive
                Content-Length: 34
                Host: 127.0.0.1:8009
                Origin: http://127.0.0.1:8009
                Referer: http://127.0.0.1:8009/
                Sec-Fetch-Dest: empty
                Sec-Fetch-Mode: cors
                Sec-Fetch-Site: same-origin
                User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36
                content-type: text/html
                range: selector=click-counter
                sec-ch-ua: "Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"
                sec-ch-ua-mobile: ?0
                sec-ch-ua-platform: "macOS"

                &lt;click-counter&gt;127&lt;/click-counter&gt;
            </pre>
            <p>
                The server replies with what it thinks the state of the body should be.
            </p>
            <pre>                HTTP/1.1 200 OK
                accept-ranges: bytes, selector
                content-type: text/html
                content-length: 34
                vary: Accept-Encoding
                date: Sat, 22 Mar 2025 09:23:19 GMT

                &lt;click-counter&gt;127&lt;/click-counter&gt;
            </pre>
            <p>
                If you don't want to use custom elements for some reason, you can alternately
                just add a <code>put</code> property to the element, with a function that alters
                the DOM appropriately, and it works in the same way.
            </p>
                <section>
                    <p>
                        This button has been clicked <span id="click-counter">92</span> times.
                    </p>
                    <script>
                        (() => {
                            let elem = document.querySelector('#click-counter');
                            elem.put = function() {
                                let value = parseInt( elem.innerHTML );
                                elem.innerHTML = value + 1;
                            }
                        })();
                    </script>
                    <button action="span#click-counter" method="put">Increment Counter</button>
                </section>
            <h2>PATCH requests</h2>
            <p>
                A patch is a slightly different beast, and requires a web server to be aware of how
                to apply DOM mutations.
            </p>
            <section>
                <table id="patchable-table" patchable="true">
                    <thead>
                        <tr>
                            <th type="col">Name</th>
                            <th type="col">Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>John Doe</td>
                            <td>johndoe@example.com</td>
                            <td><button remove="closest" selector="tr">Delete</button></td>
                        </tr>                            
                    </tbody>                
                    <tfoot>
                        <tr>
                            <td><input form="table-row" type="text" name="name"></td>
                            <td><input form="table-row" type="email" name="email"></td>
                            <td><button form="table-row">Add</button></td>
                        </tr>
                    </tfoot>
                </table>
                <form id="table-row" template="#table-row-template" action="table tbody"></form>
                <template id="table-row-template">
                    <tr>
                        <td><slot name="name"></slot></td>
                        <td><slot name="email"></slot></td>
                        <td><button remove="closest" selector="tr">Delete</button></td>
                    </tr>
                </template>
            </section>
        </section>
    
</body></html>